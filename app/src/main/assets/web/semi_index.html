<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sesame Config - Semi Design</title>
    <!-- ÂºïÂÖ• Semi Design CSS -->
    <link rel="stylesheet" href="./css/semi.min.css" />
    <style>
        body {
            background-color: var(--semi-color-bg-0);
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--semi-color-bg-1);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            padding-bottom: 40px;
        }

        .header {
            padding: 16px;
            background: var(--semi-color-bg-2);
            border-bottom: 1px solid var(--semi-color-border);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.8);
        }

        body[theme-mode='dark'] .header {
            background-color: rgba(22, 22, 26, 0.8);
        }

        .field-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--semi-color-border);
        }

        .field-row:last-child {
            border-bottom: none;
        }

        .field-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--semi-color-text-0);
            flex: 1;
            padding-right: 12px;
        }

        .field-control {
            flex-shrink: 0;
            max-width: 60%;
        }

        .section-padding {
            padding: 0 16px;
        }

        /* ÂàóË°®ÂºπÁ™óÊ†∑Âºè */
        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--semi-color-border);
        }

        .list-item-left {
            display: flex;
            align-items: center;
            flex: 1;
            overflow: hidden;
        }

        .list-item-name {
            margin-left: 10px;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--semi-color-text-0);
        }

        .list-count-input {
            width: 80px;
            margin-left: 10px;
        }

        .sheet-footer {
            display: flex;
            justify-content: flex-end;
            padding-top: 16px;
            border-top: 1px solid var(--semi-color-border);
        }
    </style>

    <!-- React & ReactDOM -->
    <script src="./js/react.development.js"></script>
    <script src="./js/react-dom.development.js"></script>
    <!-- Semi UI JS -->
    <script src="./js/semi-ui.min.js"></script>
    <!-- Semi Icons -->
    <script src="./js/semi-icons.min.js"></script>
    <!-- Babel -->
    <script src="./js/babel.min.js"></script>
</head>

<body>
    <div id="app"></div>

    <script type="text/babel">
        const switchMode = () => {
            const body = document.body;
            if (body.hasAttribute('theme-mode')) {
                body.removeAttribute('theme-mode');
                window.setMode('light');
            } else {
                body.setAttribute('theme-mode', 'dark');
                window.setMode('dark');
            }
        };
        const { useState, useEffect, useMemo, useRef } = React;
        const { Collapse, Switch, Input, RadioGroup, Radio, Button, Toast, SideSheet, Checkbox, InputNumber, Typography } = SemiUI;
        const { IconSearch } = SemiIcons;
        const { Title, Text } = Typography;

        // --- Mock Data Wrappers ---
        const getTabsData = () => {
            try { return JSON.parse(window.HOOK.getTabs()); } catch (e) { return []; }
        };

        const getModelData = (code) => {
            try { return JSON.parse(window.HOOK.getModel(code)); } catch (e) { return []; }
        };

        const getFieldData = (modelCode, fieldCode) => {
            try {
                const res = JSON.parse(window.HOOK.getField(modelCode, fieldCode));
                return res.expandValue || [];
            } catch (e) {
                return [];
            }
        }

        // --- Main Component ---
        const App = () => {

            // 1. Â§ÑÁêÜ‰∏ªÈ¢òËá™Âä®ÂàáÊç¢ÈÄªËæë
            const applyTheme = () => {
                let isDark = false;
                if (window.HOOK && window.HOOK.isNightMode) {
                    try { isDark = window.HOOK.isNightMode(); } catch (e) { }
                } else {
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) isDark = true;
                }
                const body = document.body;
                if (isDark) {
                    body.setAttribute('theme-mode', 'dark');
                    if (window.setMode) window.setMode('dark');
                } else {
                    if (body.hasAttribute('theme-mode')) body.removeAttribute('theme-mode');
                    if (window.setMode) window.setMode('light');
                }
            };
            applyTheme();

            const [tabs, setTabs] = useState([]);
            const [modelsMap, setModelsMap] = useState({});

            // ÂàóË°®ÂºπÁ™óÁõ∏ÂÖ≥ÁöÑ State
            const [sheetVisible, setSheetVisible] = useState(false);
            const [sheetConfig, setSheetConfig] = useState({ modelCode: '', fieldCode: '', type: '', title: '', desc: '' });
            const [sheetList, setSheetList] = useState([]); // ÂÆåÊï¥ÂàóË°®Êï∞ÊçÆ
            const [sheetSearch, setSheetSearch] = useState(''); // ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
            const [selectedIds, setSelectedIds] = useState(new Set()); // ÈÄâ‰∏≠ÁöÑIDÈõÜÂêà
            const [selectedCounts, setSelectedCounts] = useState({}); // IDÂØπÂ∫îÁöÑÊï∞ÂÄº

            // ÂàùÂßãÂåñ
            useEffect(() => {
                const tabsData = getTabsData();
                setTabs(tabsData);
                const initialMap = {};
                tabsData.forEach(tab => {
                    initialMap[tab.modelCode] = getModelData(tab.modelCode);
                });
                setModelsMap(initialMap);
            }, []);

            const handleFieldChange = (modelCode, fieldCode, newValue) => {
                setModelsMap(prev => {
                    const currentFields = [...prev[modelCode]];
                    const fieldIndex = currentFields.findIndex(f => f.code === fieldCode);
                    if (fieldIndex > -1) {
                        currentFields[fieldIndex] = { ...currentFields[fieldIndex], configValue: String(newValue) };
                    }
                    const savePayload = {};
                    currentFields.forEach(f => { savePayload[f.code] = { configValue: f.configValue }; });
                    if (window.HOOK && window.HOOK.setModel) {
                        window.HOOK.setModel(modelCode, JSON.stringify(savePayload));
                    }
                    return { ...prev, [modelCode]: currentFields };
                });
            };

            // --- ÂàóË°®ÂºπÁ™óÈÄªËæë (ÂÖ≥ÈîÆ‰øÆÊîπÈÉ®ÂàÜ) ---

            const openListSheet = (modelCode, fieldItem) => {
                const { code, name, type, desc, configValue } = fieldItem;

                // 1. ÂÖàËé∑ÂèñÂéüÂßãÊï∞ÊçÆ
                let listData = getFieldData(modelCode, code);

                // 2. Ëß£ÊûêÂΩìÂâçÂ∑≤ÈÄâ‰∏≠ÁöÑ IDÔºåÁî®‰∫éÊéíÂ∫è
                const newSelectedIds = new Set();
                const newSelectedCounts = {};
                try {
                    const parsed = JSON.parse(configValue);
                    if (type === 'SELECT') {
                        if (Array.isArray(parsed)) parsed.forEach(id => newSelectedIds.add(id));
                    } else if (type === 'SELECT_AND_COUNT') {
                        if (parsed && typeof parsed === 'object') {
                            Object.entries(parsed).forEach(([id, count]) => {
                                newSelectedIds.add(id);
                                newSelectedCounts[id] = count;
                            });
                        }
                    }
                } catch (e) { console.error("Parse config value failed", e); }

                // 3. ÊâßË°åÊéíÂ∫èÔºöÂ∑≤ÈÄâ‰∏≠ÁöÑÊéíÂú®ÊúÄÂâçÈù¢ (Âè™ÊâßË°å‰∏ÄÊ¨°)
                // sort ‰ºöÊîπÂèòÂéüÊï∞ÁªÑÔºåËøôÈáåÁõ¥Êé•Êìç‰Ωú listData Âç≥ÂèØ
                listData.sort((a, b) => {
                    const isA = newSelectedIds.has(a.id);
                    const isB = newSelectedIds.has(b.id);
                    if (isA && !isB) return -1; // a Âú®Ââç
                    if (!isA && isB) return 1;  // b Âú®Ââç
                    return 0; // ‰øùÊåÅÂéüÈ°∫Â∫è
                });

                // 4. Â∞ÜÊéíÂ•ΩÂ∫èÁöÑÊï∞ÊçÆËÆæÁΩÆÂà∞ State
                setSheetList(listData);
                setSheetConfig({ modelCode, fieldCode: code, type, title: name, desc: desc });
                setSheetSearch('');
                setSelectedIds(newSelectedIds);
                setSelectedCounts(newSelectedCounts);
                setSheetVisible(true);
            };

            const saveSheet = () => {
                const { modelCode, fieldCode, type } = sheetConfig;
                let newValueStr = "";
                if (type === 'SELECT') {
                    const arr = Array.from(selectedIds);
                    newValueStr = JSON.stringify(arr);
                } else {
                    const obj = {};
                    selectedIds.forEach(id => {
                        obj[id] = selectedCounts[id] !== undefined ? selectedCounts[id] : 0;
                    });
                    newValueStr = JSON.stringify(obj);
                }
                handleFieldChange(modelCode, fieldCode, newValueStr);
                setSheetVisible(false);
                Toast.success("Â∑≤‰øùÂ≠òÂàóË°®ËÆæÁΩÆ");
            };

            const toggleItem = (id, checked) => {
                const newIds = new Set(selectedIds);
                if (checked) {
                    newIds.add(id);
                    if (sheetConfig.type === 'SELECT_AND_COUNT' && selectedCounts[id] === undefined) {
                        setSelectedCounts(prev => ({ ...prev, [id]: 1 }));
                    }
                } else {
                    newIds.delete(id);
                }
                setSelectedIds(newIds);
            };

            const handleCountChange = (id, val) => {
                setSelectedCounts(prev => ({ ...prev, [id]: val }));
            };

            const toggleAll = () => {
                const filteredList = sheetList.filter(item => item.name.includes(sheetSearch));
                const allSelected = filteredList.every(item => selectedIds.has(item.id));
                const newIds = new Set(selectedIds);
                filteredList.forEach(item => {
                    if (allSelected) {
                        newIds.delete(item.id);
                    } else {
                        newIds.add(item.id);
                        if (sheetConfig.type === 'SELECT_AND_COUNT' && selectedCounts[item.id] === undefined) {
                            setSelectedCounts(prev => ({ ...prev, [item.id]: 1 }));
                        }
                    }
                });
                setSelectedIds(newIds);
            };

            // Ê∏≤ÊüìËøáÊª§ÂêéÁöÑÂàóË°® (Ê≥®ÊÑèÔºöËøôÈáå‰∏çÂÜçÂåÖÂê´ÊéíÂ∫èÈÄªËæë)
            const renderSheetList = () => {
                const filtered = sheetList.filter(item => item.name.toLowerCase().includes(sheetSearch.toLowerCase()));

                if (filtered.length === 0) return <div style={{ padding: 20, textAlign: 'center', color: '#999' }}>Êó†Êï∞ÊçÆ</div>;

                return filtered.map(item => {
                    const isChecked = selectedIds.has(item.id);
                    return (
                        <div key={item.id} className="list-item">
                            <div className="list-item-left" onClick={() => toggleItem(item.id, !isChecked)}>
                                <Checkbox checked={isChecked} style={{ pointerEvents: 'none' }} />
                                <span className="list-item-name">{item.name}</span>
                            </div>
                            {sheetConfig.type === 'SELECT_AND_COUNT' && isChecked && (
                                <InputNumber
                                    className="list-count-input"
                                    size="small"
                                    min={0}
                                    value={selectedCounts[item.id] || 0}
                                    onChange={(v) => handleCountChange(item.id, v)}
                                    placeholder="Êï∞Èáè"
                                />
                            )}
                        </div>
                    );
                });
            };

            // --- Ê∏≤Êüì‰∏ªÁïåÈù¢ÈÖçÁΩÆÈ°π ---
            const renderFieldItem = (modelCode, item) => {
                const { type, name, code, configValue, desc, expandKey } = item;
                if (type === 'BOOLEAN') {
                    return (
                        <div className="field-row" key={code}>
                            <div className="field-label">{name}</div>
                            <div className="field-control">
                                <Switch checked={configValue === 'true'} onChange={(v) => handleFieldChange(modelCode, code, v)} />
                            </div>
                        </div>
                    );
                }
                if (['MULTIPLY_INTEGER', 'LIST', 'INTEGER', 'STRING', 'TEXT'].includes(type)) {
                    return (
                        <div className="field-row" key={code}>
                            <div className="field-label">{name}</div>
                            <div className="field-control" style={{ width: '50%' }}>
                                <Input value={configValue} onChange={(v) => handleFieldChange(modelCode, code, v)} placeholder="ËØ∑ËæìÂÖ•..." />
                            </div>
                        </div>
                    );
                }
                if (type === 'URL_TEXT') {
                    return (
                        <div className="field-row" key={code}>
                            <Text link={{ href: configValue }}>{name}</Text>
                        </div>
                    );
                }
                if (type === 'CHOICE') {
                    return (
                        <div style={{ padding: '12px 0', borderBottom: '1px solid var(--semi-color-border)' }} key={code}>
                            <div style={{ marginBottom: 8, fontWeight: 600, fontSize: 14, color: 'var(--semi-color-text-0)' }}>{name}</div>
                            <RadioGroup type="button" value={Number(configValue)} onChange={(e) => handleFieldChange(modelCode, code, e.target.value)}>
                                {expandKey && expandKey.map((label, idx) => (<Radio value={idx} key={idx}>{label}</Radio>))}
                            </RadioGroup>
                        </div>
                    );
                }
                if (['SELECT', 'SELECT_AND_COUNT'].includes(type)) {
                    let count = 0;
                    try {
                        const parsed = JSON.parse(configValue);
                        count = Array.isArray(parsed) ? parsed.length : Object.keys(parsed).length;
                    } catch (e) { }
                    return (
                        <div className="field-row" key={code}>
                            <div className="field-label">{name}</div>
                            <div className="field-control">
                                <Button theme='solid' type='secondary' onClick={() => openListSheet(modelCode, item)}>
                                    Â∑≤ÈÄâ {count} È°π
                                </Button>
                            </div>
                        </div>
                    )
                }
                return null;
            };

            return (
                <div className="container">
                    <div className="header">
                        <Title heading={2} style={{ margin: 0 }}>Sesame-TK ËÆæÁΩÆ</Title>
                        <Button disabled theme="borderless">Ê¨¢ËøéÂä†ÂÖ•Êàë‰ª¨ÁöÑÁªÑÁªá</Button>
                        <Text style={{ marginRight: 15 }} link={{ href: 'https://t.me/fansirsqi_xposed_sesame' }}> ‚û§TG </Text> |
                        <Text style={{ marginLeft: 15, marginRight: 15 }} link={{ href: 'https://qm.qq.com/q/740DFRGOXe' }}> ‚û§QQ </Text>
                        <Button style={{}} onClick={switchMode} > ÂàáÊç¢‰∏ªÈ¢ò </Button>
                    </div>

                    <div className="section-padding">
                        <Collapse accordion defaultActiveKey={tabs[0]?.modelCode}>
                            {tabs.map((tab) => (
                                <Collapse.Panel
                                    header={<div style={{ fontWeight: 600 }}>{tab.modelName}</div>}
                                    itemKey={tab.modelCode}
                                    key={tab.modelCode}
                                >
                                    <div>
                                        {modelsMap[tab.modelCode] ? (
                                            modelsMap[tab.modelCode].map(field => renderFieldItem(tab.modelCode, field))
                                        ) : (
                                            <div style={{ padding: 20, textAlign: 'center' }}>Âä†ËΩΩ‰∏≠...</div>
                                        )}
                                    </div>
                                </Collapse.Panel>
                            ))}
                        </Collapse>
                    </div>

                    <div style={{ padding: 20, textAlign: 'center' }}>
                        <Button
                            theme='solid'
                            type='danger'
                            block
                            onClick={() => {
                                if (window.HOOK && window.HOOK.saveOnExit) {
                                    window.HOOK.saveOnExit();
                                } else if (window.Android && window.Android.onExit) {
                                    window.Android.onExit();
                                } else {
                                    console.log("Ê®°Êãü: ‰øùÂ≠òÂπ∂ÈÄÄÂá∫");
                                }
                            }}
                        >
                            ÈÄÄÂá∫Âπ∂‰øùÂ≠ò
                        </Button>
                        <Text style={{ marginTop: 15, color: '#999', fontSize: 12 }} link={{ href: 'https://github.com/Fansirsqi/Sesame-TK' }}> GithubÂºÄÊ∫êÂú∞ÂùÄ </Text>
                        <div style={{ marginTop: 5, color: '#999', fontSize: 14 }}>ü•≥ Power by <Text link={{ href: 'https://semi.design/' }}>Semi.Design</Text> ¬© 2025-12-11 With <Text link={{ href: 'https://github.com/Fansirsqi' }}>Byseven Offical</Text> </div>
                        <div style={{ marginTop: 5, color: '#999', fontSize: 14 }}>Ver: {window.HOOK.getBuildInfo()}</div>
                    </div>

                    {/* ‰æßËæπÂàóË°®ÂºπÁ™ó */}
                    <SideSheet
                        title={<span style={{ fontSize: 16, fontWeight: 600 }}>{sheetConfig.title}</span>}
                        visible={sheetVisible}
                        onCancel={() => setSheetVisible(false)}
                        width="100%"
                        placement="right"
                        bodyStyle={{ padding: 10 }}
                    >
                        <Text>{sheetConfig.desc}</Text>
                        <div style={{ padding: '10px 16px', borderBottom: '1px solid var(--semi-color-border)' }}>
                            <Input
                                prefix={<IconSearch />}
                                placeholder="ÊêúÁ¥¢ÂêçÁß∞..."
                                value={sheetSearch}
                                onChange={setSheetSearch}
                            />
                            <div style={{ marginTop: 10, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <Checkbox onChange={toggleAll} checked={false}>
                                    ÂÖ®ÈÄâ/ÂèçÈÄâ (ÂΩìÂâçÂèØËßÅ)
                                </Checkbox>
                                <Text size="small" type="secondary">Â∑≤ÈÄâ: {selectedIds.size}</Text>
                            </div>
                        </div>
                        <div style={{ padding: '0 16px', overflowY: 'auto', height: 'calc(100vh - 180px)' }}>
                            {renderSheetList()}
                        </div>
                        <div className="sheet-footer" style={{ padding: '16px', justifyContent: 'space-around', position: 'absolute', bottom: 0, width: '100%', background: 'var(--semi-color-bg-1)' }}>
                            <Button style={{ marginRight: 10 }} onClick={() => setSheetVisible(false)}>ÂèñÊ∂à</Button>
                            <Button theme="solid" onClick={saveSheet}>‰øùÂ≠ò</Button>
                        </div>
                    </SideSheet>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('app'));
    </script>
</body>

</html>