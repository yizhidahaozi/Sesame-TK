<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
<!--    <title>Log Viewer</title>-->
    <style>
        :root {
          --bg: #0b0b0c;
          --fg: #e6e6e6;
          --muted: #9aa0a6;
        }
        @media (prefers-color-scheme: light) {
          :root {
            --bg: #ffffff;
            --fg: #1f1f1f;
            --muted: #666;
          }
        }
        html, body {
          margin: 0;
          padding: 0;
          background: var(--bg);
          color: var(--fg);
          font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
          line-height: 1.4;
          -webkit-text-size-adjust: 100%;
        }
        #toolbar {
          position: sticky;
          top: 0;
          background: rgba(0,0,0,0.08);
          backdrop-filter: blur(4px);
          border-bottom: 1px solid rgba(255,255,255,0.08);
          z-index: 10;
        }
        .toolbar-row {
          padding: 8px 12px;
          display: flex;
          gap: 12px;
          align-items: center;
        }
        .toolbar-row:not(:last-child) {
          border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        #filterInput {
          flex: 1;
          padding: 4px 10px;
          border: 1px solid rgba(255,255,255,0.15);
          border-radius: 6px;
          background: transparent;
          color: var(--fg);
          font-size: 12px;
        }
        #log {
          white-space: pre-wrap;      /* è‡ªåŠ¨æ¢è¡Œï¼Œä¿ç•™æ¢è¡Œç¬¦ */
          word-break: break-word;
          padding: 8px 8px 8px 8px;
          font-size: 11px;
          line-height: 1.6;           /* è¡Œé—´è·æ›´èˆ’é€‚ */
        }
        button, label {
          color: var(--fg);
          background: transparent;
          border: 1px solid rgba(255,255,255,0.15);
          padding: 4px 10px;
          border-radius: 6px;
          font-size: 12px;
        }
        button:hover { border-color: rgba(255,255,255,0.3); }
        .muted { color: var(--muted); font-size: 12px; margin-left: auto; }
        input[type="checkbox"] { vertical-align: middle; }
    </style>
</head>
<body>
<div id="toolbar">
    <!-- ç¬¬ä¸€è¡Œï¼šåŸºç¡€åŠŸèƒ½ -->
    <div class="toolbar-row">
        <label><input type="checkbox" id="autoScroll" checked /> è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨</label>
        <button onclick="clearLog()">æ¸…ç©ºæ˜¾ç¤º</button>
        <span class="muted" id="status">å°±ç»ª</span>
    </div>
    <!-- ç¬¬äºŒè¡Œï¼šç­›é€‰åŠŸèƒ½ -->
    <div class="toolbar-row">
        <input type="text" id="filterInput" placeholder="è¾“å…¥å…³é”®å­—å®æ—¶ç­›é€‰..." />
        <button onclick="clearFilter()">æ¸…é™¤ç­›é€‰</button>
        <span class="muted" id="filterStats"></span>
    </div>
</div>

<div id="loadingIndicator" style="display: none; text-align: center; padding: 10px; color: var(--muted);">
    â³ æ­£åœ¨åŠ è½½æ›´å¤š...
</div>
<div id="log"></div>

<script>
    const logEl = document.getElementById('log');
    const autoScrollEl = document.getElementById('autoScroll');
    const statusEl = document.getElementById('status');
    const filterInputEl = document.getElementById('filterInput');
    const filterStatsEl = document.getElementById('filterStats');
    const loadingIndicator = document.getElementById('loadingIndicator');

    let fullLogText = ''; // ä¿å­˜å®Œæ•´çš„æ—¥å¿—å†…å®¹
    let currentFilter = ''; // å½“å‰ç­›é€‰å…³é”®å­—
    let filterDebounceTimer = null; // é˜²æŠ–è®¡æ—¶å™¨
    
    // æ‡’åŠ è½½ç›¸å…³
    let isLoading = false;  // æ˜¯å¦æ­£åœ¨åŠ è½½
    let hasMoreData = true; // æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
    let totalAvailable = 0; // æ€»å¯ç”¨è¡Œæ•°
    let currentLoaded = 0;  // å½“å‰å·²åŠ è½½è¡Œæ•°
    let lineHeight = 0;     // å¹³å‡æ¯è¡Œé«˜åº¦ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
    let visibleLines = 0;   // å¯è§†åŒºåŸŸå¯æ˜¾ç¤ºçš„è¡Œæ•°
    let loadLinesPerBatch = 500; // æ¯æ‰¹æ¬¡åŠ è½½è¡Œæ•°ï¼ˆè‡ªé€‚åº”ï¼‰
    
    // åå°é¢„åŠ è½½ç›¸å…³
    let isPreloading = false;   // æ˜¯å¦æ­£åœ¨åå°é¢„åŠ è½½
    let preloadTimer = null;    // é¢„åŠ è½½å®šæ—¶å™¨
    let preloadStartTime = 0;   // é¢„åŠ è½½å¼€å§‹æ—¶é—´
    let wasPreloading = false;  // æ˜¯å¦æ›¾è¢«æš‚åœï¼ˆç”¨äºæ¢å¤ï¼‰
    let resumeTimer = null;     // æ¢å¤é¢„åŠ è½½å®šæ—¶å™¨
    
    // ğŸ”§ æ‡’åŠ è½½å¸¸é‡é…ç½®
    const ESTIMATED_LINE_HEIGHT = 18;  // é¢„ä¼°è¡Œé«˜ï¼ˆpxï¼‰= 11pxå­—ä½“ Ã— 1.6è¡Œé«˜
  
    const SCROLL_THRESHOLD = 300;      // è§¦å‘åŠ è½½çš„è·ç¦»é¡¶éƒ¨é˜ˆå€¼ï¼ˆpxï¼‰
    const SCREEN_MULTIPLIER = 5;       // åŠ è½½å±æ•°å€æ•°ï¼ˆ5å±æ•°æ®ï¼‰

    const MIN_LOAD_LINES = 200;        // æœ€å°åŠ è½½è¡Œæ•°

    const DEBOUNCE_SCROLL = 150;       // æ»šåŠ¨é˜²æŠ–å»¶è¿Ÿï¼ˆmsï¼‰
    const DEBOUNCE_FILTER = 500;       // ç­›é€‰é˜²æŠ–å»¶è¿Ÿï¼ˆmsï¼‰
    
    const PRELOAD_DELAY = 10000;       // é¢„åŠ è½½å»¶è¿Ÿï¼ˆmsï¼‰ï¼šåˆå§‹åŠ è½½å®Œ10ç§’åå¼€å§‹
    const PRELOAD_BATCH = 500;         // é¢„åŠ è½½æ‰¹æ¬¡å¤§å°ï¼ˆè¡Œï¼‰
    const PRELOAD_INTERVAL = 500;      // é¢„åŠ è½½é—´éš”ï¼ˆmsï¼‰ï¼šæ¯æ‰¹é—´éš”0.5ç§’
 

    function _scrollToBottom() {
      if (!autoScrollEl.checked) return;
      window.scrollTo(0, document.body.scrollHeight);
    }

    // ä¾›åŸç”Ÿè°ƒç”¨ï¼šå…¨é‡æ›¿æ¢
    function setFullText(text) {
      fullLogText = text || '';
      if (currentFilter) {
        applyFilter();
      } else {
        logEl.textContent = fullLogText;
        statusEl.textContent = 'å·²åŠ è½½ ' + (fullLogText ? fullLogText.length : 0) + ' å­—èŠ‚';
      }
      // æ³¨æ„ï¼šä¸è‡ªåŠ¨æ»šåŠ¨ï¼Œç”± onInitialLoadComplete ç»Ÿä¸€å¤„ç†
    }

    // ä¾›åŸç”Ÿè°ƒç”¨ï¼šå¢é‡è¿½åŠ 
    function appendLog(chunk) {
      if (!chunk) return;
      
      // ğŸ›‘ æš‚åœåå°é¢„åŠ è½½ï¼ˆé¿å…ä¸è¿½åŠ å†²çªï¼‰
      if (isPreloading) {
        if (preloadTimer) {
          clearTimeout(preloadTimer);
          preloadTimer = null;
        }
        wasPreloading = true;  // æ ‡è®°æ›¾è¢«æš‚åœ
        isPreloading = false;
        console.log('â¸ï¸ æš‚åœé¢„åŠ è½½ï¼ˆæ–°æ—¥å¿—è¿½åŠ ä¸­ï¼‰');
      }
      
      fullLogText += chunk;
      if (currentFilter) {
        // ç­›é€‰æ¨¡å¼ä¸‹ï¼šåªè¿½åŠ åŒ…å«å…³é”®å­—çš„è¡Œ
        const newLines = chunk.split('\n');
        const filtered = newLines.filter(line => line.includes(currentFilter));
        if (filtered.length > 0) {
          logEl.textContent += (logEl.textContent ? '\n' : '') + filtered.join('\n');
          statusEl.textContent = 'è¿½åŠ  ' + filtered.length + ' æ¡åŒ¹é…è®°å½•';
        }
      } else {
        logEl.textContent += chunk;
        statusEl.textContent = 'è¿½åŠ  ' + chunk.length + ' å­—èŠ‚';
      }
      _scrollToBottom();
      
      // ğŸ”„ è¿½åŠ å®Œæˆåï¼Œå»¶è¿Ÿæ¢å¤é¢„åŠ è½½ï¼ˆ2ç§’æ— æ–°è¿½åŠ åˆ™æ¢å¤ï¼‰
      scheduleResumePreload();
    }

    // ä¾›åŸç”Ÿè°ƒç”¨ï¼šæ‰¹é‡è¿½åŠ è¡Œï¼ˆFlow æµå¼åŠ è½½ä¸“ç”¨ï¼‰
    function appendLines(lines) {
      if (!lines || lines.length === 0) return;
      
      // ğŸ›‘ æš‚åœåå°é¢„åŠ è½½ï¼ˆé¿å…ä¸è¿½åŠ å†²çªï¼‰
      if (isPreloading) {
        if (preloadTimer) {
          clearTimeout(preloadTimer);
          preloadTimer = null;
        }
        wasPreloading = true;  // æ ‡è®°æ›¾è¢«æš‚åœ
        isPreloading = false;
        console.log('â¸ï¸ æš‚åœé¢„åŠ è½½ï¼ˆæ‰¹é‡è¿½åŠ ä¸­ï¼‰');
      }
      
      const chunk = lines.join('\n') + '\n';
      fullLogText += chunk;
      
      if (currentFilter) {
        // ç­›é€‰æ¨¡å¼ä¸‹ï¼šåªè¿½åŠ åŒ…å«å…³é”®å­—çš„è¡Œ
        const filtered = lines.filter(line => line.includes(currentFilter));
        if (filtered.length > 0) {
          logEl.textContent += (logEl.textContent ? '\n' : '') + filtered.join('\n');
          statusEl.textContent = 'è¿½åŠ  ' + filtered.length + ' æ¡åŒ¹é…è®°å½•';
        }
      } else {
        // ä½¿ç”¨ DocumentFragment ä¼˜åŒ– DOM æ“ä½œæ€§èƒ½
        const text = logEl.textContent;
        logEl.textContent = text + (text && !text.endsWith('\n') ? '\n' : '') + lines.join('\n');
        statusEl.textContent = 'å·²åŠ è½½ ' + lines.length + ' è¡Œ';
      }
      // æ³¨æ„ï¼šåˆå§‹åŠ è½½æ—¶ä¸è‡ªåŠ¨æ»šåŠ¨ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·æ“ä½œ
      
      // ğŸ”„ æ‰¹é‡è¿½åŠ å®Œæˆåï¼Œå»¶è¿Ÿæ¢å¤é¢„åŠ è½½
      scheduleResumePreload();
    }

    // æ¸…ç©ºæ˜¾ç¤ºï¼ˆä¸å½±å“åŸæ–‡ä»¶ï¼Œä»…æ¸… UIï¼‰
    function clearLog() {
      fullLogText = '';
      logEl.textContent = '';
      statusEl.textContent = 'å·²æ¸…ç©ºæ˜¾ç¤º';
    }

    // åº”ç”¨ç­›é€‰ (ä¼˜åŒ–ç‰ˆï¼šæ”¯æŒå€’æ’ç´¢å¼•åŠ é€Ÿ)
    function applyFilter(keyword) {
      // å¦‚æœæ²¡æœ‰ä¼ å…¥å…³é”®è¯ï¼Œä»è¾“å…¥æ¡†è·å–
      if (keyword === undefined) {
        keyword = filterInputEl.value.trim();
      }
      
      if (!keyword) {
        clearFilter();
        return;
      }

      currentFilter = keyword;
      statusEl.textContent = 'æ­£åœ¨ç­›é€‰...';
      filterStatsEl.textContent = '';

      // ä¼˜å…ˆä½¿ç”¨åç«¯æœç´¢ï¼ˆæ”¯æŒå®Œæ•´æ—¥å¿—æœç´¢ï¼‰
      if (window.SearchBridge && window.SearchBridge.searchLines) {
        try {
          const resultJson = window.SearchBridge.searchLines(keyword);
          const result = JSON.parse(resultJson);
          
          if (result.lines && result.lines.length > 0) {
            logEl.textContent = result.lines.join('\n');
            statusEl.textContent = 'å°±ç»ª';
            const source = result.source === 'index' ? 'ç´¢å¼•' : 'å…¨æ–‡';
            filterStatsEl.textContent = 'ğŸ” ' + result.total + ' ä¸ªç»“æœ (' + source + 'æœç´¢)';
            _scrollToBottom();
            return;
          } else if (result.total === 0) {
            logEl.textContent = '';
            statusEl.textContent = 'å°±ç»ª';
            filterStatsEl.textContent = 'ğŸ” æœªæ‰¾åˆ°åŒ¹é…ç»“æœ';
            return;
          }
        } catch (e) {
          console.warn('åç«¯æœç´¢å¤±è´¥ï¼Œå›é€€åˆ°å‰ç«¯æœç´¢:', e);
        }
      }

      // å›é€€åˆ°ä¼ ç»Ÿå‰ç«¯ç­›é€‰æ–¹å¼
      setTimeout(() => {
        const lines = fullLogText.split('\n');
        const filtered = [];

        // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…ä¸€æ¬¡æ€§å¤„ç†å¤§é‡æ•°æ®å¯¼è‡´å¡é¡¿
        const batchSize = 1000;
        let processed = 0;

        function processBatch() {
          const end = Math.min(processed + batchSize, lines.length);
          for (let i = processed; i < end; i++) {
            if (lines[i].includes(keyword)) {
              filtered.push(lines[i]);
            }
          }
          processed = end;

          if (processed < lines.length) {
            statusEl.textContent = 'ç­›é€‰ä¸­: ' + Math.floor(processed / lines.length * 100) + '%';
            setTimeout(processBatch, 0);
          } else {
            // å®Œæˆç­›é€‰
            logEl.textContent = filtered.join('\n');
            statusEl.textContent = 'å°±ç»ª';
            filterStatsEl.textContent = filtered.length + '/' + lines.length + ' è¡Œ (å‰ç«¯)';
            _scrollToBottom();
          }
        }

        processBatch();
      }, 10);
    }

    // ğŸš€ é¢„è®¡ç®—åˆå§‹åŠ è½½é‡ï¼ˆåœ¨æœ‰æ•°æ®å‰é¢„ä¼°ï¼‰
    function calculateInitialLoad() {
      const viewportHeight = window.innerHeight;
      const toolbarHeight = document.getElementById('toolbar')?.offsetHeight || 150;
      const availableHeight = viewportHeight - toolbarHeight - 50;
      
      const estimatedVisibleLines = Math.ceil(availableHeight / ESTIMATED_LINE_HEIGHT);
      const initialLoadCount = Math.max(estimatedVisibleLines * SCREEN_MULTIPLIER, MIN_LOAD_LINES);
      
      console.log('ğŸ“± é¢„è®¡ç®—åˆå§‹åŠ è½½:');
      console.log('  - å±å¹•é«˜åº¦:', viewportHeight, 'px');
      console.log('  - å¯ç”¨é«˜åº¦:', availableHeight, 'px');
      console.log('  - é¢„ä¼°è¡Œæ•°:', estimatedVisibleLines);
      console.log('  - åˆå§‹åŠ è½½:', initialLoadCount, 'è¡Œ');
      
      // é€šçŸ¥åŸç”Ÿç«¯
      if (window.SearchBridge && window.SearchBridge.setLoadBatchSize) {
        window.SearchBridge.setLoadBatchSize(initialLoadCount);
      }
      
      return initialLoadCount;
    }

    // ğŸ”¥ ç²¾ç¡®è®¡ç®—å¯è§†åŒºåŸŸèƒ½æ˜¾ç¤ºå¤šå°‘è¡Œï¼ˆæœ‰æ•°æ®åï¼‰
    function calculateVisibleLines() {
      // ç­‰å¾…DOMæ¸²æŸ“å®Œæˆ
      setTimeout(() => {
        // è®¡ç®—å¹³å‡è¡Œé«˜
        const logLines = logEl.textContent.split('\n').filter(l => l.trim());
        if (logLines.length > 0) {
          const totalHeight = logEl.scrollHeight;
          lineHeight = totalHeight / logLines.length;
          
          // è®¡ç®—å¯è§†åŒºåŸŸé«˜åº¦
          const viewportHeight = window.innerHeight;
          const toolbarHeight = document.getElementById('toolbar').offsetHeight;
          const availableHeight = viewportHeight - toolbarHeight - 50;
          
          // è®¡ç®—å¯è§†è¡Œæ•°ï¼ˆåŠ è½½æŒ‡å®šå±æ•°çš„æ•°æ®ï¼‰
          visibleLines = Math.ceil(availableHeight / lineHeight);
          loadLinesPerBatch = Math.max(visibleLines * SCREEN_MULTIPLIER, MIN_LOAD_LINES);
          
          console.log('ğŸ“ ç²¾ç¡®è®¡ç®—:');
          console.log('  - å®é™…è¡Œé«˜:', lineHeight.toFixed(1), 'px');
          console.log('  - å¯è§†åŒºåŸŸ:', availableHeight, 'px');
          console.log('  - å¯è§†è¡Œæ•°:', visibleLines);
          console.log('  - æ¯æ‰¹æ¬¡åŠ è½½:', loadLinesPerBatch, 'è¡Œ');
          
          // é€šçŸ¥åŸç”Ÿç«¯è°ƒæ•´æ‰¹æ¬¡å¤§å°
          if (window.SearchBridge && window.SearchBridge.setLoadBatchSize) {
            window.SearchBridge.setLoadBatchSize(loadLinesPerBatch);
          }
        }
      }, 100);
    }

    // åˆå§‹åŠ è½½å®Œæˆå›è°ƒï¼ˆç”±åŸç”Ÿç«¯è°ƒç”¨ï¼‰
    function onInitialLoadComplete(keywordCount, loaded, total, hasMore) {
      console.log('ğŸ“‘ åˆå§‹åŠ è½½å®Œæˆ:', loaded, '/', total, 'è¡Œ');
      
      currentLoaded = loaded;
      totalAvailable = total;
      hasMoreData = hasMore;
      
      // è®¡ç®—è‡ªé€‚åº”è¡Œæ•°
      calculateVisibleLines();
      
      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      if (hasMore) {
        statusEl.textContent = 'å·²åŠ è½½ ' + loaded + '/' + total + ' è¡Œ (å¾€ä¸Šæ»‘åŠ¨åŠ è½½æ›´å¤š)';
      } else {
        statusEl.textContent = 'å·²åŠ è½½å…¨éƒ¨ ' + total + ' è¡Œ';
      }
      
      // å¦‚æœç´¢å¼•è¿˜æœªæ„å»ºï¼Œæ˜¾ç¤ºæç¤º
      if (keywordCount === 0) {
        statusEl.textContent += ' | â³ ç´¢å¼•æ„å»ºä¸­...';
      }
      
      // åˆå§‹åŠ è½½å®Œæˆåï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæŸ¥çœ‹æœ€æ–°æ—¥å¿—ï¼‰
      setTimeout(() => {
        window.scrollTo(0, document.body.scrollHeight);
      }, 100);
      
      // ğŸ”¥ å¦‚æœè¿˜æœ‰æ›´å¤šæ•°æ®ï¼Œ10ç§’åå¯åŠ¨åå°é¢„åŠ è½½
      if (hasMore) {
        console.log('â° å°†åœ¨', PRELOAD_DELAY/1000, 'ç§’åå¼€å§‹åå°é¢„åŠ è½½');
        preloadTimer = setTimeout(() => {
          startBackgroundPreload();
        }, PRELOAD_DELAY);
      }
    }

    // ç´¢å¼•æ„å»ºå®Œæˆå›è°ƒï¼ˆç”±åŸç”Ÿç«¯è°ƒç”¨ï¼‰
    function onIndexBuilt(keywordCount) {
      console.log('ğŸ” ç´¢å¼•æ„å»ºå®Œæˆ:', keywordCount, 'ä¸ªå…³é”®è¯');
      
      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      if (hasMoreData) {
        statusEl.textContent = 'å·²åŠ è½½ ' + currentLoaded + '/' + totalAvailable + ' è¡Œ (å¾€ä¸Šæ»‘åŠ¨åŠ è½½æ›´å¤š) | ğŸ” ' + keywordCount + ' ä¸ªå…³é”®è¯';
      } else {
        statusEl.textContent = 'å·²åŠ è½½å…¨éƒ¨ ' + totalAvailable + ' è¡Œ | ğŸ” ' + keywordCount + ' ä¸ªå…³é”®è¯';
      }
    }

    // ğŸ”¥ åŠ è½½æ›´å¤šæ•°æ®
    function loadMoreData() {
      if (isLoading) {
        return;
      }
      
      // ğŸ”¥ æ£€æŸ¥æ˜¯å¦ä» fullLogText åŠ è½½ï¼ˆé¢„åŠ è½½å®Œæˆä½† DOM æœªå®Œå…¨æ›´æ–°ï¼‰
      // ä½¿ç”¨å­—ç¬¦é•¿åº¦åˆ¤æ–­æ›´å‡†ç¡®
      const fullTextLength = fullLogText.length;
      const displayedTextLength = logEl.textContent.length;
      
      if (fullTextLength > displayedTextLength && fullTextLength > 0) {
        // ä» fullLogText åŠ è½½æœªæ˜¾ç¤ºçš„éƒ¨åˆ†
        isLoading = true;
        loadingIndicator.style.display = 'block';
        statusEl.textContent = 'æ­£åœ¨åŠ è½½æ›´å¤š...';
        
        try {
          const fullLogLines = fullLogText.split('\n').filter(line => line !== '');
          const displayedLines = logEl.textContent.split('\n').filter(line => line !== '');
          const notDisplayedCount = fullLogLines.length - displayedLines.length;
          
          if (notDisplayedCount > 0) {
            const loadCount = Math.min(loadLinesPerBatch, notDisplayedCount);
            const startIndex = fullLogLines.length - displayedLines.length - loadCount;
            const endIndex = fullLogLines.length - displayedLines.length;
            const moreLines = fullLogLines.slice(startIndex, endIndex);
            
            if (moreLines.length > 0) {
              const scrollBefore = window.scrollY;
              const heightBefore = document.body.scrollHeight;
              
              const newText = moreLines.join('\n') + '\n';
              logEl.textContent = newText + logEl.textContent;
              
              const heightAfter = document.body.scrollHeight;
              const heightDiff = heightAfter - heightBefore;
              window.scrollTo(0, scrollBefore + heightDiff);
              
              const hasMore = notDisplayedCount > loadCount;
              if (hasMore) {
                statusEl.textContent = 'å·²åŠ è½½ (è¿˜æœ‰æ›´å¤šï¼Œç»§ç»­å¾€ä¸Šæ»‘åŠ¨)';
              } else {
                statusEl.textContent = 'å·²åŠ è½½å…¨éƒ¨ ' + currentLoaded + ' è¡Œ';
              }
              
              console.log('ğŸ“„ ä»å†…å­˜åŠ è½½æ›´å¤š:', moreLines.length, 'è¡Œï¼Œå‰©ä½™:', notDisplayedCount - loadCount);
            }
          }
        } catch (e) {
          console.error('âŒ ä»å†…å­˜åŠ è½½å¤±è´¥:', e);
          console.error('é”™è¯¯å †æ ˆ:', e.stack);
          statusEl.textContent = 'åŠ è½½å¤±è´¥: ' + e.message;
        } finally {
          isLoading = false;
          setTimeout(() => {
            loadingIndicator.style.display = 'none';
          }, 500);
        }
        return;
      }
      
      // å¦åˆ™ä»åç«¯åŠ è½½
      if (!hasMoreData) {
        return;
      }
      
      if (!window.SearchBridge) {
        console.error('âŒ SearchBridge æœªåˆå§‹åŒ–');
        statusEl.textContent = 'åŠ è½½å¤±è´¥: æ¥å£æœªå°±ç»ª';
        return;
      }
      
      isLoading = true;
      loadingIndicator.style.display = 'block'; // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
      statusEl.textContent = 'æ­£åœ¨åŠ è½½æ›´å¤š...';
      
      try {
        // è°ƒç”¨åŸç”Ÿæ–¹æ³•åŠ è½½æ›´å¤šï¼ˆä½¿ç”¨è‡ªé€‚åº”è¡Œæ•°ï¼‰
        console.log('ğŸ”„ è¯·æ±‚åŠ è½½æ›´å¤š:', loadLinesPerBatch, 'è¡Œ');
        const jsonResult = window.SearchBridge.loadMore(loadLinesPerBatch);
        console.log('ğŸ“¦ åŸç”Ÿè¿”å›ç»“æœ:', jsonResult);
        
        const moreLines = JSON.parse(jsonResult);
        
        if (moreLines && moreLines.length > 0) {
          // è®°å½•å½“å‰æ»šåŠ¨ä½ç½®
          const scrollBefore = window.scrollY;
          const heightBefore = document.body.scrollHeight;
          
          // åœ¨é¡¶éƒ¨æ’å…¥æ–°æ•°æ®
          const newText = moreLines.join('\n') + '\n';
          fullLogText = newText + fullLogText;
          
          // ğŸ” å¦‚æœå¤„äºç­›é€‰çŠ¶æ€ï¼Œåªæ˜¾ç¤ºåŒ¹é…çš„è¡Œ
          if (currentFilter) {
            const filteredLines = moreLines.filter(line => line.includes(currentFilter));
            if (filteredLines.length > 0) {
              const filteredText = filteredLines.join('\n') + '\n';
              logEl.textContent = filteredText + logEl.textContent;
            }
            // å¦‚æœæ²¡æœ‰åŒ¹é…çš„è¡Œï¼Œä¸æ·»åŠ ä»»ä½•å†…å®¹åˆ°æ˜¾ç¤ºåŒºåŸŸ
          } else {
            // æ­£å¸¸æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰è¡Œ
            logEl.textContent = newText + logEl.textContent;
          }
          
          // æ¢å¤æ»šåŠ¨ä½ç½®ï¼ˆä¿æŒç”¨æˆ·å½“å‰è§†å›¾ï¼‰
          const heightAfter = document.body.scrollHeight;
          const heightDiff = heightAfter - heightBefore;
          window.scrollTo(0, scrollBefore + heightDiff);
          
          currentLoaded += moreLines.length;
          
          // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤š
          hasMoreData = window.SearchBridge.hasMore();
          
          if (hasMoreData) {
            const displayText = currentFilter ? '(ç­›é€‰ä¸­) ç»§ç»­å¾€ä¸Šæ»‘åŠ¨' : 'ç»§ç»­å¾€ä¸Šæ»‘åŠ¨';
            statusEl.textContent = 'å·²åŠ è½½ ' + currentLoaded + '/' + totalAvailable + ' è¡Œ (' + displayText + ')';
          } else {
            statusEl.textContent = 'å·²åŠ è½½å…¨éƒ¨ ' + currentLoaded + ' è¡Œ';
            loadingIndicator.textContent = 'âœ… å·²åŠ è½½å…¨éƒ¨æ—¥å¿—';
          }
          
          console.log('ğŸ“„ åŠ è½½æ›´å¤šæˆåŠŸ:', moreLines.length, 'è¡Œ');
        } else {
          hasMoreData = false;
          statusEl.textContent = 'æ²¡æœ‰æ›´å¤šæ—¥å¿—';
          loadingIndicator.textContent = 'âœ… å·²åŠ è½½å…¨éƒ¨';
          console.log('âœ… å·²åŠ è½½å…¨éƒ¨æ—¥å¿—');
        }
      } catch (e) {
        console.error('âŒ åŠ è½½æ›´å¤šå¤±è´¥:', e);
        console.error('é”™è¯¯å †æ ˆ:', e.stack);
        statusEl.textContent = 'åŠ è½½å¤±è´¥: ' + e.message;
        loadingIndicator.textContent = 'âŒ åŠ è½½å¤±è´¥';
      } finally {
        isLoading = false;
        // å»¶è¿Ÿéšè—åŠ è½½æŒ‡ç¤ºå™¨
        setTimeout(() => {
          if (!hasMoreData || loadingIndicator.textContent.includes('âœ…') || loadingIndicator.textContent.includes('âŒ')) {
            // å¦‚æœå·²å…¨éƒ¨åŠ è½½æˆ–æœ‰é”™è¯¯ï¼Œä¿æŒæ˜¾ç¤º
          } else {
            loadingIndicator.style.display = 'none';
          }
        }, 500);
      }
    }

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œè§¦åº•åŠ è½½
    let scrollDebounceTimer = null;
    window.addEventListener('scroll', function() {
      if (scrollDebounceTimer) {
        clearTimeout(scrollDebounceTimer);
      }
      
      scrollDebounceTimer = setTimeout(() => {
        // æ£€æµ‹æ˜¯å¦æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼ˆæˆ–æ¥è¿‘é¡¶éƒ¨ï¼‰
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        
        if (scrollTop < SCROLL_THRESHOLD && hasMoreData && !isLoading) {
          // å¦‚æœç”¨æˆ·ä¸»åŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œæš‚åœåå°é¢„åŠ è½½ï¼Œæ”¹ä¸ºç«‹å³åŠ è½½
          if (preloadTimer) {
            clearTimeout(preloadTimer);
            preloadTimer = null;
          }
          isPreloading = false;
          
          loadMoreData();
        }
      }, DEBOUNCE_SCROLL);
    });

    // ğŸ”„ è®¡åˆ’æ¢å¤é¢„åŠ è½½ï¼ˆè¿½åŠ åœæ­¢2ç§’åï¼‰
    function scheduleResumePreload() {
      // æ¸…é™¤ä¹‹å‰çš„æ¢å¤å®šæ—¶å™¨
      if (resumeTimer) {
        clearTimeout(resumeTimer);
        resumeTimer = null;
      }
      
      // åªæœ‰æ›¾è¢«æš‚åœä¸”è¿˜æœ‰æ•°æ®æ—¶æ‰æ¢å¤
      if (!wasPreloading || !hasMoreData) {
        return;
      }
      
      // 2ç§’æ— æ–°è¿½åŠ åˆ™æ¢å¤é¢„åŠ è½½
      resumeTimer = setTimeout(() => {
        if (wasPreloading && !isPreloading && hasMoreData) {
          console.log('â–¶ï¸ æ¢å¤åå°é¢„åŠ è½½...');
          wasPreloading = false;
          startBackgroundPreload();
        }
      }, 3000);
    }

    // ğŸš€ å¯åŠ¨åå°é¢„åŠ è½½
    function startBackgroundPreload() {
      if (isPreloading || !hasMoreData) {
        return;
      }
      
      console.log('ğŸ”„ å¼€å§‹åå°é¢„åŠ è½½å‰©ä½™æ—¥å¿—...');
      preloadStartTime = Date.now(); // è®°å½•å¼€å§‹æ—¶é—´
      isPreloading = true;
      wasPreloading = false;  // æ¸…é™¤æš‚åœæ ‡è®°
      backgroundPreloadNext();
    }
    
    // ğŸ“¦ åå°é¢„åŠ è½½ä¸‹ä¸€æ‰¹
    function backgroundPreloadNext() {
      if (!hasMoreData || isLoading) {
        if (!hasMoreData) {
          // è®¡ç®—è€—æ—¶
          const loadTime = ((Date.now() - preloadStartTime) / 1000).toFixed(1);
          console.log('âœ… åå°é¢„åŠ è½½å®Œæˆï¼Œè€—æ—¶:', loadTime, 'ç§’');
          isPreloading = false;
          statusEl.textContent = 'å·²åŠ è½½å…¨éƒ¨ ' + currentLoaded + ' è¡Œ (ç”¨æ—¶' + loadTime + 'ç§’)';
        }
        return;
      }
      
      try {
        const jsonResult = window.SearchBridge.loadMore(PRELOAD_BATCH);
        const moreLines = JSON.parse(jsonResult);
        
        if (moreLines && moreLines.length > 0) {
          // ğŸš€ åªæ›´æ–°æ•°æ®ï¼Œä¸æ›´æ–° DOMï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
          const newText = moreLines.join('\n') + '\n';
          fullLogText = newText + fullLogText;
          // âŒ ç§»é™¤ DOM æ›´æ–°ï¼šlogEl.textContent = newText + logEl.textContent;
          
          currentLoaded += moreLines.length;
          hasMoreData = window.SearchBridge.hasMore();
          
          // æ›´æ–°çŠ¶æ€ï¼šæ˜¾ç¤ºå·²åŠ è½½è¡Œæ•°å’Œå·²ç”¨æ—¶é—´
          const elapsedTime = ((Date.now() - preloadStartTime) / 1000).toFixed(1);
          const remaining = totalAvailable - currentLoaded;
          const percent = Math.floor((currentLoaded / totalAvailable) * 100);
          statusEl.textContent = 'å·²åŠ è½½ ' + currentLoaded + '/' + totalAvailable + ' è¡Œ (' + percent + '%) | åå°åŠ è½½ä¸­ (' + elapsedTime + 'ç§’)';
          
          console.log('ğŸ“¦ åå°é¢„åŠ è½½: +' + moreLines.length + ' è¡Œ (' + currentLoaded + '/' + totalAvailable + ')');
          
          // ç»§ç»­ä¸‹ä¸€æ‰¹ï¼ˆé—´éš”åŠ è½½ï¼‰
          if (hasMoreData) {
            preloadTimer = setTimeout(() => {
              backgroundPreloadNext();
            }, PRELOAD_INTERVAL);
          } else {
            // è®¡ç®—è€—æ—¶
            const loadTime = ((Date.now() - preloadStartTime) / 1000).toFixed(1);
            isPreloading = false;
            statusEl.textContent = 'å·²åŠ è½½å…¨éƒ¨ ' + currentLoaded + ' è¡Œ (ç”¨æ—¶' + loadTime + 'ç§’)';
            console.log('âœ… æ‰€æœ‰æ—¥å¿—å·²åŠ è½½å®Œæˆï¼Œè€—æ—¶:', loadTime, 'ç§’');
          }
        } else {
          hasMoreData = false;
          isPreloading = false;
          // è®¡ç®—è€—æ—¶
          const loadTime = ((Date.now() - preloadStartTime) / 1000).toFixed(1);
          statusEl.textContent = 'å·²åŠ è½½å…¨éƒ¨ ' + currentLoaded + ' è¡Œ (ç”¨æ—¶' + loadTime + 'ç§’)';
        }
      } catch (e) {
        console.error('âŒ åå°é¢„åŠ è½½å¤±è´¥:', e);
        isPreloading = false;
      }
    }

    // æ¸…é™¤ç­›é€‰
    function clearFilter() {
      currentFilter = '';
      filterInputEl.value = '';
      logEl.textContent = fullLogText;
      statusEl.textContent = 'å°±ç»ª';
      filterStatsEl.textContent = '';
      _scrollToBottom();
    }

    // ğŸš€ åŠ è½½å…¨éƒ¨å¹¶è·³åˆ°é¡¶éƒ¨ï¼ˆä¾›åç«¯è°ƒç”¨ï¼‰
    function loadAllAndScrollToTop() {
      console.log('ğŸ” è¯·æ±‚è·³åˆ°é¡¶éƒ¨...');
      
      // 1. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ•°æ®éƒ½å·²æ˜¾ç¤º
      const fullTextLength = fullLogText.length;
      const displayedTextLength = logEl.textContent.length;
      
      if (fullTextLength > displayedTextLength && fullTextLength > 0) {
        // æœ‰æœªæ˜¾ç¤ºçš„æ•°æ®ï¼Œå…ˆå…¨éƒ¨åŠ è½½åˆ° DOM
        console.log('ğŸ“¦ åŠ è½½å‰©ä½™æ•°æ®åˆ° DOM...');
        statusEl.textContent = 'æ­£åœ¨åŠ è½½å…¨éƒ¨æ—¥å¿—...';
        
        try {
          const fullLogLines = fullLogText.split('\n').filter(line => line !== '');
          const displayedLines = logEl.textContent.split('\n').filter(line => line !== '');
          const notDisplayedCount = fullLogLines.length - displayedLines.length;
          
          if (notDisplayedCount > 0) {
            // ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æœªæ˜¾ç¤ºçš„è¡Œ
            const startIndex = 0;
            const endIndex = fullLogLines.length - displayedLines.length;
            const moreLines = fullLogLines.slice(startIndex, endIndex);
            
            if (moreLines.length > 0) {
              const newText = moreLines.join('\n') + '\n';
              logEl.textContent = newText + logEl.textContent;
              
              console.log('âœ… å·²åŠ è½½å…¨éƒ¨æ•°æ®:', moreLines.length, 'è¡Œ');
              statusEl.textContent = 'å·²åŠ è½½å…¨éƒ¨ ' + fullLogLines.length + ' è¡Œ';
            }
          }
        } catch (e) {
          console.error('âŒ åŠ è½½å…¨éƒ¨æ•°æ®å¤±è´¥:', e);
        }
      }
      
      // 2. æ»šåŠ¨åˆ°é¡¶éƒ¨
      setTimeout(() => {
        window.scrollTo(0, 0);
        console.log('âœ… å·²æ»šåŠ¨åˆ°ç¬¬ä¸€è¡Œ');
      }, 100);
    }

    // ğŸ”¥ å®æ—¶ç­›é€‰ï¼šè¾“å…¥æ—¶è‡ªåŠ¨ç­›é€‰ï¼ˆå¸¦é˜²æŠ–ä¼˜åŒ–ï¼‰
    filterInputEl.addEventListener('input', function(e) {
      const keyword = e.target.value.trim();
      
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (filterDebounceTimer) {
        clearTimeout(filterDebounceTimer);
      }
      
      // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œç«‹å³æ¸…é™¤ç­›é€‰
      if (!keyword) {
        clearFilter();
        return;
      }
      
      // é˜²æŠ–ï¼šå»¶è¿Ÿåæ‰§è¡Œç­›é€‰ï¼ˆé¿å…é¢‘ç¹è§¦å‘ï¼‰
      filterDebounceTimer = setTimeout(() => {
        applyFilter(keyword);
      }, DEBOUNCE_FILTER);
    });

    // ğŸ“± ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ˆå±å¹•æ—‹è½¬ã€çª—å£è°ƒæ•´ï¼‰
    let resizeTimer = null;
    window.addEventListener('resize', function() {
      if (resizeTimer) {
        clearTimeout(resizeTimer);
      }
      
      resizeTimer = setTimeout(() => {
        if (currentLoaded > 0) {
          calculateVisibleLines();
          console.log('ğŸ“± çª—å£è°ƒæ•´ï¼Œé‡æ–°è®¡ç®—è‡ªé€‚åº”è¡Œæ•°');
        }
      }, 300);
    });

</script>
</body>
</html>
