<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Log Viewer</title>
    <style>
        :root {
          --bg: #0b0b0c;
          --fg: #e6e6e6;
          --muted: #9aa0a6;
        }
        @media (prefers-color-scheme: light) {
          :root {
            --bg: #ffffff;
            --fg: #1f1f1f;
            --muted: #666;
          }
        }
        html, body {
          margin: 0;
          padding: 0;
          background: var(--bg);
          color: var(--fg);
          font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
          line-height: 1.4;
          -webkit-text-size-adjust: 100%;
        }
        #toolbar {
          position: sticky;
          top: 0;
          background: rgba(0,0,0,0.08);
          backdrop-filter: blur(4px);
          border-bottom: 1px solid rgba(255,255,255,0.08);
          z-index: 10;
        }
        .toolbar-row {
          padding: 8px 12px;
          display: flex;
          gap: 12px;
          align-items: center;
        }
        .toolbar-row:not(:last-child) {
          border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        #filterInput {
          flex: 1;
          padding: 4px 10px;
          border: 1px solid rgba(255,255,255,0.15);
          border-radius: 6px;
          background: transparent;
          color: var(--fg);
          font-size: 12px;
        }
        #log {
          white-space: pre-wrap;      /* è‡ªåŠ¨æ¢è¡Œï¼Œä¿ç•™æ¢è¡Œç¬¦ */
          word-break: break-word;
          padding: 5px 5px 5px 5px;
          font-size: 10px;
        }
        button, label {
          color: var(--fg);
          background: transparent;
          border: 1px solid rgba(255,255,255,0.15);
          padding: 4px 10px;
          border-radius: 6px;
          font-size: 12px;
        }
        button:hover { border-color: rgba(255,255,255,0.3); }
        .muted { color: var(--muted); font-size: 12px; margin-left: auto; }
        input[type="checkbox"] { vertical-align: middle; }
    </style>
</head>
<body>
<div id="toolbar">
    <!-- ç¬¬ä¸€è¡Œï¼šåŸºç¡€åŠŸèƒ½ -->
    <div class="toolbar-row">
        <label><input type="checkbox" id="autoScroll" checked /> è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨</label>
        <button onclick="clearLog()">æ¸…ç©ºæ˜¾ç¤º</button>
        <span class="muted" id="status">å°±ç»ª</span>
    </div>
    <!-- ç¬¬äºŒè¡Œï¼šç­›é€‰åŠŸèƒ½ -->
    <div class="toolbar-row">
        <input type="text" id="filterInput" placeholder="è¾“å…¥å…³é”®å­—å®æ—¶ç­›é€‰..." />
        <button onclick="clearFilter()">æ¸…é™¤ç­›é€‰</button>
        <span class="muted" id="filterStats"></span>
    </div>
</div>

<div id="loadingIndicator" style="display: none; text-align: center; padding: 10px; color: var(--muted);">
    â³ æ­£åœ¨åŠ è½½æ›´å¤š...
</div>
<div id="log"></div>

<script>
    const logEl = document.getElementById('log');
    const autoScrollEl = document.getElementById('autoScroll');
    const statusEl = document.getElementById('status');
    const filterInputEl = document.getElementById('filterInput');
    const filterStatsEl = document.getElementById('filterStats');
    const loadingIndicator = document.getElementById('loadingIndicator');

    let fullLogText = ''; // ä¿å­˜å®Œæ•´çš„æ—¥å¿—å†…å®¹
    let currentFilter = ''; // å½“å‰ç­›é€‰å…³é”®å­—
    let filterDebounceTimer = null; // é˜²æŠ–è®¡æ—¶å™¨
    
    // æ‡’åŠ è½½ç›¸å…³
    let isLoading = false;  // æ˜¯å¦æ­£åœ¨åŠ è½½
    let hasMoreData = true; // æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
    let totalAvailable = 0; // æ€»å¯ç”¨è¡Œæ•°
    let currentLoaded = 0;  // å½“å‰å·²åŠ è½½è¡Œæ•°
    let lineHeight = 0;     // å¹³å‡æ¯è¡Œé«˜åº¦ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
    let visibleLines = 0;   // å¯è§†åŒºåŸŸå¯æ˜¾ç¤ºçš„è¡Œæ•°
    let loadLinesPerBatch = 500; // æ¯æ‰¹æ¬¡åŠ è½½è¡Œæ•°ï¼ˆè‡ªé€‚åº”ï¼‰

    function _scrollToBottom() {
      if (!autoScrollEl.checked) return;
      window.scrollTo(0, document.body.scrollHeight);
    }

    // ä¾›åŸç”Ÿè°ƒç”¨ï¼šå…¨é‡æ›¿æ¢
    function setFullText(text) {
      fullLogText = text || '';
      if (currentFilter) {
        applyFilter();
      } else {
        logEl.textContent = fullLogText;
        statusEl.textContent = 'å·²åŠ è½½ ' + (fullLogText ? fullLogText.length : 0) + ' å­—èŠ‚';
      }
      // æ³¨æ„ï¼šä¸è‡ªåŠ¨æ»šåŠ¨ï¼Œç”± onInitialLoadComplete ç»Ÿä¸€å¤„ç†
    }

    // ä¾›åŸç”Ÿè°ƒç”¨ï¼šå¢é‡è¿½åŠ 
    function appendLog(chunk) {
      if (!chunk) return;
      fullLogText += chunk;
      if (currentFilter) {
        // ç­›é€‰æ¨¡å¼ä¸‹ï¼šåªè¿½åŠ åŒ…å«å…³é”®å­—çš„è¡Œ
        const newLines = chunk.split('\n');
        const filtered = newLines.filter(line => line.includes(currentFilter));
        if (filtered.length > 0) {
          logEl.textContent += (logEl.textContent ? '\n' : '') + filtered.join('\n');
          statusEl.textContent = 'è¿½åŠ  ' + filtered.length + ' æ¡åŒ¹é…è®°å½•';
        }
      } else {
        logEl.textContent += chunk;
        statusEl.textContent = 'è¿½åŠ  ' + chunk.length + ' å­—èŠ‚';
      }
      _scrollToBottom();
    }

    // ä¾›åŸç”Ÿè°ƒç”¨ï¼šæ‰¹é‡è¿½åŠ è¡Œï¼ˆFlow æµå¼åŠ è½½ä¸“ç”¨ï¼‰
    function appendLines(lines) {
      if (!lines || lines.length === 0) return;
      
      const chunk = lines.join('\n') + '\n';
      fullLogText += chunk;
      
      if (currentFilter) {
        // ç­›é€‰æ¨¡å¼ä¸‹ï¼šåªè¿½åŠ åŒ…å«å…³é”®å­—çš„è¡Œ
        const filtered = lines.filter(line => line.includes(currentFilter));
        if (filtered.length > 0) {
          logEl.textContent += (logEl.textContent ? '\n' : '') + filtered.join('\n');
          statusEl.textContent = 'è¿½åŠ  ' + filtered.length + ' æ¡åŒ¹é…è®°å½•';
        }
      } else {
        // ä½¿ç”¨ DocumentFragment ä¼˜åŒ– DOM æ“ä½œæ€§èƒ½
        const text = logEl.textContent;
        logEl.textContent = text + (text && !text.endsWith('\n') ? '\n' : '') + lines.join('\n');
        statusEl.textContent = 'å·²åŠ è½½ ' + lines.length + ' è¡Œ';
      }
      // æ³¨æ„ï¼šåˆå§‹åŠ è½½æ—¶ä¸è‡ªåŠ¨æ»šåŠ¨ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·æ“ä½œ
    }

    // æ¸…ç©ºæ˜¾ç¤ºï¼ˆä¸å½±å“åŸæ–‡ä»¶ï¼Œä»…æ¸… UIï¼‰
    function clearLog() {
      fullLogText = '';
      logEl.textContent = '';
      statusEl.textContent = 'å·²æ¸…ç©ºæ˜¾ç¤º';
    }

    // åº”ç”¨ç­›é€‰ (ä¼˜åŒ–ç‰ˆï¼šæ”¯æŒå€’æ’ç´¢å¼•åŠ é€Ÿ)
    function applyFilter(keyword) {
      // å¦‚æœæ²¡æœ‰ä¼ å…¥å…³é”®è¯ï¼Œä»è¾“å…¥æ¡†è·å–
      if (keyword === undefined) {
        keyword = filterInputEl.value.trim();
      }
      
      if (!keyword) {
        clearFilter();
        return;
      }

      currentFilter = keyword;
      statusEl.textContent = 'æ­£åœ¨ç­›é€‰...';
      filterStatsEl.textContent = '';

      // å°è¯•ä½¿ç”¨å€’æ’ç´¢å¼•å¿«é€Ÿæœç´¢
      if (window.SearchBridge) {
        try {
          const lineNumbers = JSON.parse(window.SearchBridge.search(keyword));
          
          if (lineNumbers && lineNumbers.length > 0) {
            // ä½¿ç”¨ç´¢å¼•å¿«é€Ÿå®šä½
            const lines = fullLogText.split('\n');
            const filtered = lineNumbers.map(i => lines[i]).filter(l => l);
            
            logEl.textContent = filtered.join('\n');
            statusEl.textContent = 'å°±ç»ª';
            filterStatsEl.textContent = 'ğŸ” ' + filtered.length + ' ä¸ªç»“æœ';
            _scrollToBottom();
            return;
          }
        } catch (e) {
          console.warn('ç´¢å¼•æœç´¢å¤±è´¥ï¼Œå›é€€åˆ°æ™®é€šæœç´¢:', e);
        }
      }

      // å›é€€åˆ°ä¼ ç»Ÿç­›é€‰æ–¹å¼
      setTimeout(() => {
        const lines = fullLogText.split('\n');
        const filtered = [];

        // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…ä¸€æ¬¡æ€§å¤„ç†å¤§é‡æ•°æ®å¯¼è‡´å¡é¡¿
        const batchSize = 1000;
        let processed = 0;

        function processBatch() {
          const end = Math.min(processed + batchSize, lines.length);
          for (let i = processed; i < end; i++) {
            if (lines[i].includes(keyword)) {
              filtered.push(lines[i]);
            }
          }
          processed = end;

          if (processed < lines.length) {
            statusEl.textContent = 'ç­›é€‰ä¸­: ' + Math.floor(processed / lines.length * 100) + '%';
            setTimeout(processBatch, 0);
          } else {
            // å®Œæˆç­›é€‰
            logEl.textContent = filtered.join('\n');
            statusEl.textContent = 'å°±ç»ª';
            filterStatsEl.textContent = filtered.length + '/' + lines.length + ' è¡Œ';
            _scrollToBottom();
          }
        }

        processBatch();
      }, 10);
    }

    // ğŸš€ é¢„è®¡ç®—åˆå§‹åŠ è½½é‡ï¼ˆåœ¨æœ‰æ•°æ®å‰é¢„ä¼°ï¼‰
    function calculateInitialLoad() {
      const viewportHeight = window.innerHeight;
      const toolbarHeight = document.getElementById('toolbar')?.offsetHeight || 150;
      const availableHeight = viewportHeight - toolbarHeight - 50;
      
      // é¢„ä¼°è¡Œé«˜ï¼ˆä¸€èˆ¬æ˜¯ 12-16pxï¼‰
      const estimatedLineHeight = 14;
      const estimatedVisibleLines = Math.ceil(availableHeight / estimatedLineHeight);
      
      // é¢„åŠ è½½ 5 å±æ•°æ®ï¼ˆç¡®ä¿ä¸ä¼šå¤ªå¿«åˆ°é¡¶ï¼‰
      const initialLoadCount = Math.max(estimatedVisibleLines * 5, 300);
      
      console.log('ğŸ“± é¢„è®¡ç®—åˆå§‹åŠ è½½:');
      console.log('  - å±å¹•é«˜åº¦:', viewportHeight, 'px');
      console.log('  - å¯ç”¨é«˜åº¦:', availableHeight, 'px');
      console.log('  - é¢„ä¼°è¡Œæ•°:', estimatedVisibleLines);
      console.log('  - åˆå§‹åŠ è½½:', initialLoadCount, 'è¡Œ');
      
      // é€šçŸ¥åŸç”Ÿç«¯
      if (window.SearchBridge && window.SearchBridge.setLoadBatchSize) {
        window.SearchBridge.setLoadBatchSize(initialLoadCount);
      }
      
      return initialLoadCount;
    }

    // ğŸ”¥ ç²¾ç¡®è®¡ç®—å¯è§†åŒºåŸŸèƒ½æ˜¾ç¤ºå¤šå°‘è¡Œï¼ˆæœ‰æ•°æ®åï¼‰
    function calculateVisibleLines() {
      // ç­‰å¾…DOMæ¸²æŸ“å®Œæˆ
      setTimeout(() => {
        // è®¡ç®—å¹³å‡è¡Œé«˜
        const logLines = logEl.textContent.split('\n').filter(l => l.trim());
        if (logLines.length > 0) {
          const totalHeight = logEl.scrollHeight;
          lineHeight = totalHeight / logLines.length;
          
          // è®¡ç®—å¯è§†åŒºåŸŸé«˜åº¦
          const viewportHeight = window.innerHeight;
          const toolbarHeight = document.getElementById('toolbar').offsetHeight;
          const availableHeight = viewportHeight - toolbarHeight - 50; // å‡å»å·¥å…·æ å’Œè¾¹è·
          
          // è®¡ç®—å¯è§†è¡Œæ•°ï¼ˆåŠ è½½3-5å±çš„æ•°æ®ï¼‰
          visibleLines = Math.ceil(availableHeight / lineHeight);
          loadLinesPerBatch = Math.max(visibleLines * 5, 300); // è‡³å°‘300è¡Œï¼Œ5å±æ•°æ®
          
          console.log('ğŸ“ ç²¾ç¡®è®¡ç®—:');
          console.log('  - å®é™…è¡Œé«˜:', lineHeight.toFixed(1), 'px');
          console.log('  - å¯è§†åŒºåŸŸ:', availableHeight, 'px');
          console.log('  - å¯è§†è¡Œæ•°:', visibleLines);
          console.log('  - æ¯æ‰¹æ¬¡åŠ è½½:', loadLinesPerBatch, 'è¡Œ');
          
          // é€šçŸ¥åŸç”Ÿç«¯è°ƒæ•´æ‰¹æ¬¡å¤§å°
          if (window.SearchBridge && window.SearchBridge.setLoadBatchSize) {
            window.SearchBridge.setLoadBatchSize(loadLinesPerBatch);
          }
        }
      }, 100);
    }

    // åˆå§‹åŠ è½½å®Œæˆå›è°ƒï¼ˆç”±åŸç”Ÿç«¯è°ƒç”¨ï¼‰
    function onInitialLoadComplete(keywordCount, loaded, total, hasMore) {
      console.log('ğŸ“‘ åˆå§‹åŠ è½½å®Œæˆ:', loaded, '/', total, 'è¡Œ');
      console.log('ğŸ” ç´¢å¼•å°±ç»ª:', keywordCount, 'ä¸ªå…³é”®è¯');
      
      currentLoaded = loaded;
      totalAvailable = total;
      hasMoreData = hasMore;
      
      // è®¡ç®—è‡ªé€‚åº”è¡Œæ•°
      calculateVisibleLines();
      
      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      if (hasMore) {
        statusEl.textContent = 'å·²åŠ è½½ ' + loaded + '/' + total + ' è¡Œ (å¾€ä¸Šæ»‘åŠ¨åŠ è½½æ›´å¤š)';
      } else {
        statusEl.textContent = 'å·²åŠ è½½å…¨éƒ¨ ' + total + ' è¡Œ';
      }
      
      // åˆå§‹åŠ è½½å®Œæˆåï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæŸ¥çœ‹æœ€æ–°æ—¥å¿—ï¼‰
      setTimeout(() => {
        window.scrollTo(0, document.body.scrollHeight);
      }, 100);
    }

    // ğŸ”¥ åŠ è½½æ›´å¤šæ•°æ®
    function loadMoreData() {
      if (isLoading || !hasMoreData) {
        return;
      }
      
      if (!window.SearchBridge) {
        console.error('âŒ SearchBridge æœªåˆå§‹åŒ–');
        statusEl.textContent = 'åŠ è½½å¤±è´¥: æ¥å£æœªå°±ç»ª';
        return;
      }
      
      isLoading = true;
      loadingIndicator.style.display = 'block'; // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
      statusEl.textContent = 'æ­£åœ¨åŠ è½½æ›´å¤š...';
      
      try {
        // è°ƒç”¨åŸç”Ÿæ–¹æ³•åŠ è½½æ›´å¤šï¼ˆä½¿ç”¨è‡ªé€‚åº”è¡Œæ•°ï¼‰
        console.log('ğŸ”„ è¯·æ±‚åŠ è½½æ›´å¤š:', loadLinesPerBatch, 'è¡Œ');
        const jsonResult = window.SearchBridge.loadMore(loadLinesPerBatch);
        console.log('ğŸ“¦ åŸç”Ÿè¿”å›ç»“æœ:', jsonResult);
        
        const moreLines = JSON.parse(jsonResult);
        
        if (moreLines && moreLines.length > 0) {
          // è®°å½•å½“å‰æ»šåŠ¨ä½ç½®
          const scrollBefore = window.scrollY;
          const heightBefore = document.body.scrollHeight;
          
          // åœ¨é¡¶éƒ¨æ’å…¥æ–°æ•°æ®
          const newText = moreLines.join('\n') + '\n';
          fullLogText = newText + fullLogText;
          logEl.textContent = newText + logEl.textContent;
          
          // æ¢å¤æ»šåŠ¨ä½ç½®ï¼ˆä¿æŒç”¨æˆ·å½“å‰è§†å›¾ï¼‰
          const heightAfter = document.body.scrollHeight;
          const heightDiff = heightAfter - heightBefore;
          window.scrollTo(0, scrollBefore + heightDiff);
          
          currentLoaded += moreLines.length;
          
          // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤š
          hasMoreData = window.SearchBridge.hasMore();
          
          if (hasMoreData) {
            statusEl.textContent = 'å·²åŠ è½½ ' + currentLoaded + '/' + totalAvailable + ' è¡Œ (ç»§ç»­å¾€ä¸Šæ»‘åŠ¨)';
          } else {
            statusEl.textContent = 'å·²åŠ è½½å…¨éƒ¨ ' + currentLoaded + ' è¡Œ';
            loadingIndicator.textContent = 'âœ… å·²åŠ è½½å…¨éƒ¨æ—¥å¿—';
          }
          
          console.log('ğŸ“„ åŠ è½½æ›´å¤šæˆåŠŸ:', moreLines.length, 'è¡Œ');
        } else {
          hasMoreData = false;
          statusEl.textContent = 'æ²¡æœ‰æ›´å¤šæ—¥å¿—';
          loadingIndicator.textContent = 'âœ… å·²åŠ è½½å…¨éƒ¨';
          console.log('âœ… å·²åŠ è½½å…¨éƒ¨æ—¥å¿—');
        }
      } catch (e) {
        console.error('âŒ åŠ è½½æ›´å¤šå¤±è´¥:', e);
        console.error('é”™è¯¯å †æ ˆ:', e.stack);
        statusEl.textContent = 'åŠ è½½å¤±è´¥: ' + e.message;
        loadingIndicator.textContent = 'âŒ åŠ è½½å¤±è´¥';
      } finally {
        isLoading = false;
        // å»¶è¿Ÿéšè—åŠ è½½æŒ‡ç¤ºå™¨
        setTimeout(() => {
          if (!hasMoreData || loadingIndicator.textContent.includes('âœ…') || loadingIndicator.textContent.includes('âŒ')) {
            // å¦‚æœå·²å…¨éƒ¨åŠ è½½æˆ–æœ‰é”™è¯¯ï¼Œä¿æŒæ˜¾ç¤º
          } else {
            loadingIndicator.style.display = 'none';
          }
        }, 500);
      }
    }

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œè§¦åº•åŠ è½½
    let scrollDebounceTimer = null;
    window.addEventListener('scroll', function() {
      if (scrollDebounceTimer) {
        clearTimeout(scrollDebounceTimer);
      }
      
      scrollDebounceTimer = setTimeout(() => {
        // æ£€æµ‹æ˜¯å¦æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼ˆæˆ–æ¥è¿‘é¡¶éƒ¨ï¼‰
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const threshold = 300; // è·ç¦»é¡¶éƒ¨300pxæ—¶è§¦å‘
        
        if (scrollTop < threshold && hasMoreData && !isLoading) {
          loadMoreData();
        }
      }, 100);
    });

    // æ¸…é™¤ç­›é€‰
    function clearFilter() {
      currentFilter = '';
      filterInputEl.value = '';
      logEl.textContent = fullLogText;
      statusEl.textContent = 'å°±ç»ª';
      filterStatsEl.textContent = '';
      _scrollToBottom();
    }

    // ğŸ”¥ å®æ—¶ç­›é€‰ï¼šè¾“å…¥æ—¶è‡ªåŠ¨ç­›é€‰ï¼ˆå¸¦é˜²æŠ–ä¼˜åŒ–ï¼‰
    filterInputEl.addEventListener('input', function(e) {
      const keyword = e.target.value.trim();
      
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (filterDebounceTimer) {
        clearTimeout(filterDebounceTimer);
      }
      
      // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œç«‹å³æ¸…é™¤ç­›é€‰
      if (!keyword) {
        clearFilter();
        return;
      }
      
      // é˜²æŠ–ï¼š300ms åæ‰§è¡Œç­›é€‰ï¼ˆé¿å…é¢‘ç¹è§¦å‘ï¼‰
      filterDebounceTimer = setTimeout(() => {
        applyFilter(keyword);
      }, 300);
    });

    // ğŸ“± ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ˆå±å¹•æ—‹è½¬ã€çª—å£è°ƒæ•´ï¼‰
    let resizeTimer = null;
    window.addEventListener('resize', function() {
      if (resizeTimer) {
        clearTimeout(resizeTimer);
      }
      
      resizeTimer = setTimeout(() => {
        if (currentLoaded > 0) {
          calculateVisibleLines();
          console.log('ğŸ“± çª—å£è°ƒæ•´ï¼Œé‡æ–°è®¡ç®—è‡ªé€‚åº”è¡Œæ•°');
        }
      }, 300);
    });

    // ä¸ºé˜²æ­¢ä¸€æ¬¡æ€§æ³¨å…¥è¶…å¤§æ–‡æœ¬å¯¼è‡´æ‰å¸§ï¼Œå¯ç”¨ä»¥ä¸‹èŠ‚æµç‰ˆï¼ˆå¯é€‰ï¼‰ï¼š
    // window.appendLogBatched = (function() {
    //   let buffer = '';
    //   let scheduled = false;
    //   return function(chunk) {
    //     buffer += chunk || '';
    //     if (!scheduled) {
    //       scheduled = true;
    //       requestAnimationFrame(() => {
    //         logEl.textContent += buffer;
    //         buffer = '';
    //         scheduled = false;
    //         _scrollToBottom();
    //       });
    //     }
    //   }
    // })();
</script>
</body>
</html>
