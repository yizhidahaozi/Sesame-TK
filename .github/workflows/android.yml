name: ğŸ“¦ æ„å»º 0.2.7 é­”æ”¹ç‰ˆæœ¬
run-name: ğŸ“¦ ${{ github.actor }} @ æ„å»º 0.2.7 é­”æ”¹ç‰ˆæœ¬

on:
  push:
    branches: ["n"]
  pull_request:
    branches: ["n"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: è®¾ç½®æ—¶åŒº
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "å½“å‰æ—¶é—´: $(date)"

      - name: Checkout ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "zulu"
          cache: gradle

      - name: è®¾ç½® Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper

      - name: æˆæƒ gradlew
        run: chmod +x gradlew

      - name: ğŸ› ï¸ ç¼–è¯‘ APK
        run: ./gradlew assembleNormalRelease assembleCompatibleRelease -Pversion=${{ github.ref_name }}

      - name: ğŸ“¦ æŸ¥æ‰¾ APK
        id: locate_apks
        run: |
          normal_apk=$(find app/build/outputs/apk/normal/release -name "*.apk" | head -n 1)
          compatible_apk=$(find app/build/outputs/apk/compatible/release -name "*.apk" | head -n 1)
          echo "normal_apk=$normal_apk" >> $GITHUB_OUTPUT
          echo "compatible_apk=$compatible_apk" >> $GITHUB_OUTPUT

      - name: ğŸ” ç­¾å APK
        id: sign_apks
        uses: ilharp/sign-android-release@v2
        with:
          releaseDir: app/build/outputs/apk
          signingKey: ${{ secrets.ANDROID_SIGNING_KEY }}
          keyAlias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
          buildToolsVersion: 36.0.0

      - name: ğŸ“ æå–ç­¾å APK è·¯å¾„
        id: extract_apks
        run: |
          IFS=':' read -r -a files <<< "${{ steps.sign_apks.outputs.signedFiles }}"
          for file in "${files[@]}"; do
            if [[ "$file" == *Normal* ]]; then
              echo "signed_normal=$file" >> $GITHUB_OUTPUT
            elif [[ "$file" == *Compatible* ]]; then
              echo "signed_compatible=$file" >> $GITHUB_OUTPUT
            fi
          done

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: apk-signed
          path: |
            ${{ steps.extract_apks.outputs.signed_normal }}
            ${{ steps.extract_apks.outputs.signed_compatible }}

      - name: ğŸ“œ è·å–ç‰ˆæœ¬å·
        id: extract_info
        run: |
          filename=$(basename "${{ steps.extract_apks.outputs.signed_normal }}")
          version=$(echo "$filename" | sed -E 's/.*-Normal-(.*)-signed\.apk/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ğŸ“Š è·å–æäº¤æ—¥å¿—
        id: commit_details
        run: |
          # è·å–æäº¤æ—¥å¿—ï¼Œå¹¶å»é™¤ç‰¹æ®Šç¬¦å·ï¼ˆå¦‚æ‹¬å·ã€å°–æ‹¬å·ã€æ¢è¡Œç¬¦ç­‰ï¼‰
          MSG=$(git log -5 --pretty=format:"- %s by %an" --no-merges | sed 's/[^a-zA-Z0-9 \-_/\.]//g')
          
          # è¾“å‡ºå¤„ç†åçš„æ¶ˆæ¯
          echo "COMMITS=$MSG" >> $GITHUB_OUTPUT

      # ğŸ“¨ å‘é€ Telegram æ¶ˆæ¯ï¼ˆæ›´ç¾è§‚ï¼‰
      - name: ğŸ“¢ å‘é€æ„å»ºæ¶ˆæ¯åˆ° Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          message: |
            ğŸ“¦ *Sesame 0.2.7 é­”æ”¹ç‰ˆæœ¬å·²æ„å»ºå®Œæˆï¼*
            
            ğŸ”– ç‰ˆæœ¬å·: `${{ steps.extract_info.outputs.version }}`
            ğŸ›  åˆ†æ”¯: `${{ github.ref_name }}`
            ğŸ‘¤ æ„å»ºè€…: `${{ github.actor }}`

            ğŸ“œ æ›´æ–°å†…å®¹:
            ${{ steps.commit_details.outputs.COMMITS }}

            ğŸ“¥ ä¸‹è½½è¯´æ˜:
            - ğŸ“± *Normal*: é€‚ç”¨äº Android 8.0 åŠä»¥ä¸Š
            - ğŸ“² *Compatible*: é€‚ç”¨äº Android 5.1 ~ 7.0

          format: markdown

      - name: ğŸ“¤ å‘é€ APK - Normal
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          document: ${{ steps.extract_apks.outputs.signed_normal }}

      - name: ğŸ“¤ å‘é€ APK - Compatible
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          document: ${{ steps.extract_apks.outputs.signed_compatible }}

      # ğŸ“¦ å‘å¸ƒåˆ° GitHub Release
      - name: ğŸ“¦ å‘å¸ƒ Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.extract_info.outputs.version }}
          name: "ğŸ“¦ Sesame 0.2.7 é­”æ”¹ç‰ˆ - v${{ steps.extract_info.outputs.version }}"
          draft: false
          prerelease: false
          generate_release_notes: false
          files: |
            ${{ steps.extract_apks.outputs.signed_normal }}
            ${{ steps.extract_apks.outputs.signed_compatible }}
          body: |
            ## âœ¨ æ›´æ–°å†…å®¹
            ${{ steps.commit_details.outputs.COMMITS }}

            ## ğŸ“¥ ä¸‹è½½è¯´æ˜
            - ğŸ“± **Normal**ï¼šé€‚ç”¨äº Android 8.0+
            - ğŸ“² **Compatible**ï¼šé€‚ç”¨äº Android 5.1 ~ 7.0

            ğŸš¨ *å¢™å†…ä¸å†æ›´æ–°ï¼Œå€’å–å¿…æ­»å…¨å®¶*