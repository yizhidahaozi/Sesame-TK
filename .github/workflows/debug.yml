name: ğŸ Build Debug APK
run-name: ğŸ Debug Build - ${{ github.actor }}

on:
  push:
    branches: [ "n" ]
  pull_request:
    branches: [ "n" ]
  workflow_dispatch:

jobs:
  debug-build:
    runs-on: ubuntu-latest

    steps:
      - name: â° Set Timezone to Asia/Shanghai
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "Current time: $(date)"

      - name: ğŸ‘¨ğŸ»â€ğŸ’» Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}

      - name: â˜• Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "zulu"
          cache: gradle

      - name: ğŸ¤ Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false
          gradle-version: wrapper

      - name: â˜ï¸ Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: ğŸ”¥ Build Debug APK with Gradle
        # ä¿®æ”¹ä¸º assembleDebug
        run: ./gradlew assembleDebug -Pversion=${{ github.ref_name }}

      - name: ğŸ“Š Locate Debug APKs
        id: locate_apks
        run: |
          # è·¯å¾„ä¿®æ”¹ä¸º debug ç›®å½•
          debug_dir="app/build/outputs/apk/debug"
          
          # æŸ¥æ‰¾å„ä¸ªæ¶æ„çš„åŒ… (å¦‚æœä½ çš„ debug é…ç½®æœªå¼€å¯åˆ†åŒ…ï¼Œå¯èƒ½åªæœ‰ universal)
          arm64_apk=$(find "$debug_dir" -name "*-arm64-v8a-*.apk" | head -n 1)
          armv7_apk=$(find "$debug_dir" -name "*-armeabi-v7a-*.apk" | head -n 1)
          x86_apk=$(find "$debug_dir" -name "*-x86-*.apk" | head -n 1)
          x86_64_apk=$(find "$debug_dir" -name "*-x86_64-*.apk" | head -n 1)
          # å¦‚æœæ²¡æœ‰ç‰¹å®šæ¶æ„åŒ…ï¼Œé€šå¸¸ debug åŒ…åä¸º app-debug.apkï¼Œè¿™é‡Œå°è¯•ä½œä¸º universal æ•è·
          universal_apk=$(find "$debug_dir" -name "*-universal-*.apk" | head -n 1)
          if [ -z "$universal_apk" ]; then
             universal_apk=$(find "$debug_dir" -name "*debug.apk" | head -n 1)
          fi

          echo "arm64_apk=$arm64_apk" >> $GITHUB_OUTPUT
          echo "armv7_apk=$armv7_apk" >> $GITHUB_OUTPUT
          echo "x86_apk=$x86_apk" >> $GITHUB_OUTPUT
          echo "x86_64_apk=$x86_64_apk" >> $GITHUB_OUTPUT
          echo "universal_apk=$universal_apk" >> $GITHUB_OUTPUT

      # ç›´æ¥ä¸Šä¼  Artifactsï¼Œä¸å†ç­¾åï¼Œä¸å†å‘ TG

      - name: ğŸš€ Upload Debug APK - arm64-v8a
        if: steps.locate_apks.outputs.arm64_apk != ''
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-arm64-v8a
          path: ${{ steps.locate_apks.outputs.arm64_apk }}

      - name: ğŸš€ Upload Debug APK - armeabi-v7a
        if: steps.locate_apks.outputs.armv7_apk != ''
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-armeabi-v7a
          path: ${{ steps.locate_apks.outputs.armv7_apk }}

      - name: ğŸš€ Upload Debug APK - x86
        if: steps.locate_apks.outputs.x86_apk != ''
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-x86
          path: ${{ steps.locate_apks.outputs.x86_apk }}

      - name: ğŸš€ Upload Debug APK - x86_64
        if: steps.locate_apks.outputs.x86_64_apk != ''
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-x86_64
          path: ${{ steps.locate_apks.outputs.x86_64_apk }}

      - name: ğŸš€ Upload Debug APK - Universal
        if: steps.locate_apks.outputs.universal_apk != ''
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-universal
          path: ${{ steps.locate_apks.outputs.universal_apk }}